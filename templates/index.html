<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RagaSense</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg: #f6f7fb;
            --card: #ffffff;
            --ink: #101826;
            --muted: #667289;
            --brand: #5856d6;
            --line: #e8eaf2;
            --chip: #eef0f8;
            --alpha: #60a5fa;
            --beta: #fb7185;
            --theta: #8b5cf6;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font-family: "DM Sans", system-ui, sans-serif
        }

        header {
            padding: 36px 20px 8px;
            text-align: center
        }

        header h1 {
            margin: 0;
            font-size: 2.3rem
        }

        header p {
            margin: 8px 0 0;
            color: var(--muted)
        }

        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px
        }

        /* wider app container */
        .grid {
            display: grid;
            gap: 18px
        }

        @media (min-width:1200px) {
            .grid {
                grid-template-columns: 560px 1fr
            }
        }

        /* wider left pane */

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 18px;
            padding: 18px
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap
        }

        select,
        button {
            border-radius: 12px;
            padding: 10px 14px;
            font-size: 15px
        }

        select {
            border: 1px solid var(--line);
            background: var(--card)
        }

        button {
            background: var(--brand);
            color: #fff;
            border: none;
            cursor: pointer;
            font-weight: 600
        }

        button:hover {
            filter: brightness(.95)
        }

        .badge {
            display: inline-grid;
            place-items: center;
            min-height: 44px;
            padding: 0 12px;
            border: 1px solid var(--line);
            border-radius: 12px;
            background: var(--chip);
            font-weight: 600
        }

        .kpis {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(3, 1fr)
        }

        .kpi {
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 10px
        }

        .kpi small {
            color: var(--muted)
        }

        .bar {
            height: 12px;
            width: 100%;
            background: #f1f2f8;
            border: 1px solid var(--line);
            border-radius: 999px;
            overflow: hidden
        }

        .bar>span {
            display: block;
            height: 100%;
            width: 0
        }

        .alpha>span {
            background: linear-gradient(90deg, #93c5fd, var(--alpha))
        }

        .beta>span {
            background: linear-gradient(90deg, #fca5a5, var(--beta))
        }

        .theta>span {
            background: linear-gradient(90deg, #c4b5fd, var(--theta))
        }

        .subtle {
            color: var(--muted);
            font-size: .92rem
        }

        .section-title {
            margin: 10px 0 8px;
            font-weight: 700
        }

        /* Targets */
        .targets {
            display: grid;
            gap: 8px
        }

        .target-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center
        }

        .label {
            font-size: .9rem;
            color: var(--muted);
            min-width: 130px
        }

        .chip {
            padding: 4px 12px;
            background: var(--chip);
            border: 1px solid var(--line);
            border-radius: 999px;
            font-weight: 600
        }

        .explain {
            margin-top: 8px
        }

        /* VA plot */
        .va-wrap {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 16px;
            align-items: center
        }

        @media (max-width:720px) {
            .va-wrap {
                grid-template-columns: 1fr
            }
        }

        /* Rasa encyclopedia */
        .rasa-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px
        }

        .rasa-card {
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 10px;
            cursor: pointer
        }

        .rasa-card:hover {
            box-shadow: 0 3px 12px rgba(0, 0, 0, .06)
        }

        /* YouTube */
        .video-wrap {
            position: relative;
            width: 100%;
            max-width: 480px;
            aspect-ratio: 16/9;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--line);
            background: #000
        }

        .video-wrap iframe {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%
        }

        /* modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .5);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px
        }

        .modal.open {
            display: flex
        }

        .modal .box {
            background: #fff;
            color: var(--ink);
            width: min(1100px, 96vw);
            max-height: 84vh;
            overflow: auto;
            border-radius: 16px;
            padding: 16px
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th,
        td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--line);
            text-align: left;
            white-space: nowrap
        }

        th {
            color: var(--muted)
        }

        /* Add styles for prominent Rasa/Raga output */
        .rasa-raga-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 0;
        }
    </style>
</head>

<body>
    <header>
        <h1>RagaSense</h1>
        <p>Translate EEG signals into emotional Rasas and musical prescriptions.</p>
    </header>

    <main class="grid">
        <!-- LEFT: controls + outputs -->
        <section class="card">
            <div class="row">
                <select id="profile">
                    <!-- labels are Profile 1..6; values still map to your underlying CSV keys -->
                    <option value="">Select profile…</option>
                    <option value="calm">Profile 1</option>
                    <option value="focused">Profile 2</option>
                    <option value="anxious">Profile 3</option>
                    <option value="lowmood">Profile 4</option>
                    <option value="joyful">Profile 5</option>
                    <option value="curious">Profile 6</option>
                </select>
                <button id="predict">Predict Rasa</button>
            </div>

            <div class="kpis" style="margin-top:8px">
                <div class="kpi"><small>Valence</small>
                    <div class="bar alpha"><span id="valence"></span></div>
                </div>
                <div class="kpi"><small>Arousal</small>
                    <div class="bar beta"><span id="arousal"></span></div>
                </div>
                <div class="kpi"><small>Stress (β − α)</small>
                    <div class="bar theta"><span id="stress"></span></div>
                </div>
            </div>

            <h3 class="section-title">Feature influence</h3>
            <div class="kpis" style="margin-bottom:8px">
                <div class="kpi">
                    <div class="row" style="justify-content:space-between">
                        <small class="subtle">theta weight</small>
                        <small id="w-theta" class="subtle">—</small>
                    </div>
                    <div class="bar theta"><span id="b-theta"></span></div>
                </div>
                <div class="kpi">
                    <div class="row" style="justify-content:space-between">
                        <small class="subtle">alpha weight</small>
                        <small id="w-alpha" class="subtle">—</small>
                    </div>
                    <div class="bar alpha"><span id="b-alpha"></span></div>
                </div>
                <div class="kpi">
                    <div class="row" style="justify-content:space-between">
                        <small class="subtle">beta weight</small>
                        <small id="w-beta" class="subtle">—</small>
                    </div>
                    <div class="bar beta"><span id="b-beta"></span></div>
                </div>
            </div>

            <h3 class="section-title">Valence–Arousal map</h3>
            <div class="va-wrap">
                <div style="position:relative; width:260px; height:260px;">
                    <svg id="vaPlot" width="260" height="260" viewBox="0 0 100 100"
                        style="border:1px solid var(--line); border-radius:8px; background:#fff; display:block;">
                        <g id="grid"></g>
                        <circle id="vaDot" cx="50" cy="50" r="3.2" fill="var(--brand)" />
                    </svg>
                    <!-- Removed axis labels -->
                    <div style="position:absolute; left:0; right:0; bottom:-22px;">
                        <div class="row" style="display: none; gap:18px;">
                            <small class="subtle">Valence <span id="valence" class="subtle">—</span></small>
                            <small class="subtle">Arousal <span id="arousal" class="subtle">—</span></small>
                        </div>
                    </div>
                </div>
                <div class="subtle">
                    <b>Valence</b> is pleasantness. <b>Arousal</b> is energy.
                    We place your point in this plane using EEG bands.
                </div>
            </div>
        </section>

        <!-- RIGHT: targeted regions, encyclopedia, video, dataset -->
        <section class="card">
            <!-- NEW prominent Rasa/Raga output row -->
            <div class="row" style="gap:24px; margin-bottom:18px; align-items:center;">
                <div class="rasa-raga-col">
                    <div id="rasa" style="font-size:2.2rem; font-weight:800; color:var(--brand); margin-bottom:4px;">—
                    </div>
                    <div style="font-size:1.1rem; color:var(--muted); font-weight:600;">Rasa</div>
                </div>
                <div class="rasa-raga-col">
                    <div id="raga" style="font-size:2.2rem; font-weight:800; color:var(--theta); margin-bottom:4px;">—
                    </div>
                    <div style="font-size:1.1rem; color:var(--muted); font-weight:600;">Raga</div>
                </div>
            </div>

            <h3 class="section-title">Targeted brain regions</h3>
            <div id="targets" class="targets">
                <div class="target-row" style="margin-bottom:10px;">
                    <div class="label">Primary</div>
                    <div id="t-primary"></div>
                </div>
                <div class="target-row">
                    <div class="label">Secondary</div>
                    <div id="t-secondary"></div>
                </div>
                <p id="t-explain" class="subtle explain">Pick a profile or run a prediction to see which regions this
                    session leans on.</p>
            </div>

            <h3 class="section-title">Rasa encyclopedia</h3>
            <div id="rasaGrid" class="rasa-grid"></div>

            <h3 class="section-title" style="display: none;">Sample listening</h3>
            <div class="row" style="display: none;">
                <div class="video-wrap"><iframe id="yt" src="" title="Raga sample"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe></div>
                <div style="flex:1; min-width:240px">
                    <div class="badge" style="margin-bottom:8px">Now playing: <span id="ragaNow"
                            style="margin-left:6px">—</span></div>
                    <p id="ragaInfo" class="subtle" style="margin:0">Pick a rasa or run a prediction to load an example.
                    </p>
                </div>
            </div>

            <div class="row" style="justify-content:flex-end; margin-top:10px">
                <button id="peek">Peek dataset</button>
            </div>
        </section>
    </main>

    <!-- DATASET MODAL -->
    <div id="modal" class="modal">
        <div class="box">
            <div class="row" style="justify-content:space-between; align-items:center">
                <h3 style="margin:0">Dataset preview</h3>
                <button id="close">Close</button>
            </div>
            <div id="tableWrap" style="margin-top:10px"></div>
        </div>
    </div>

    <!-- <footer style="text-align:center; color:var(--muted); padding:18px 0">© RagaSense</footer> -->

    <script>
        // ---------- rasas / ragas (swap YouTube IDs) ----------
        const RASAS = [
            { key: "Shanta", blurb: "peace, stillness, equanimity" },
            { key: "Karuna", blurb: "compassion, tenderness, sorrow" },
            { key: "Veera", blurb: "courage, confidence, resolve" },
            { key: "Raudra", blurb: "anger, intensity, heat" },
            { key: "Hasya", blurb: "joy, laughter, play" },
            { key: "Bhayanaka", blurb: "fear, vigilance, caution" },
            { key: "Bibhatsa", blurb: "aversion, disgust, rejection" },
            { key: "Adbhuta", blurb: "wonder, curiosity, awe" },
            { key: "Shringara", blurb: "love, attraction, beauty" },
        ];
        const RAGAS = {
            Shanta: { name: "Revati", yt: "VIDEO_ID_REVATI", blurb: "Pentatonic calm. Soft focus." },
            Karuna: { name: "Nilambari", yt: "VIDEO_ID_NILAMBARI", blurb: "Tender and soothing." },
            Veera: { name: "Shankarabharanam", yt: "VIDEO_ID_SHANKARABHARANAM", blurb: "Bright confidence." },
            Raudra: { name: "Simhendramadhyamam", yt: "VIDEO_ID_SIMHENDRA", blurb: "Intense and fiery." },
            Hasya: { name: "Mohanam", yt: "VIDEO_ID_MOHANAM", blurb: "Playful brightness." },
            Bhayanaka: { name: "Todi", yt: "VIDEO_ID_TODI", blurb: "Alert and uneasy." },
            Bibhatsa: { name: "Vakulabharanam", yt: "VIDEO_ID_VAKULA", blurb: "Earthy, raw color." },
            Adbhuta: { name: "Hamsadhwani", yt: "VIDEO_ID_HAMSADHWANI", blurb: "Sparkly curiosity." },
            Shringara: { name: "Kalyani", yt: "VIDEO_ID_KALYANI", blurb: "Romantic and expansive." },
        };

        // ---------- feature centers for fallbacks ----------
        const PROFILE = {
            calm: { alpha: .82, beta: .35, theta: .45 },
            focused: { alpha: .60, beta: .80, theta: .35 },
            anxious: { alpha: .35, beta: .85, theta: .75 },
            lowmood: { alpha: .55, beta: .30, theta: .70 },
            joyful: { alpha: .75, beta: .70, theta: .50 },
            curious: { alpha: .70, beta: .55, theta: .50 },
        };

        // ---------- targeted regions maps ----------
        const PROFILE_TARGETS = {
            calm: { primary: ["Temporal", "Occipital"], secondary: ["Parietal"], note: "Soothing auditory pathways and imagery" },
            focused: { primary: ["Frontal", "Parietal"], secondary: ["Central"], note: "Executive focus and visuospatial attention" },
            anxious: { primary: ["Frontal", "Temporal"], secondary: ["Parietal"], note: "Cognitive control over affective reactivity" },
            lowmood: { primary: ["Frontal"], secondary: ["Temporal"], note: "Motivation and affect regulation" },
            joyful: { primary: ["Temporal", "Frontal"], secondary: ["Parietal"], note: "Affective tone with social-cognitive uplift" },
            curious: { primary: ["Parietal", "Frontal"], secondary: ["Occipital"], note: "Integration, attention, and visual exploration" },
        };
        const RASA_TARGETS = {
            Shanta: { primary: ["Temporal", "Occipital"], secondary: ["Parietal"], note: "Calm tone and visual stillness" },
            Karuna: { primary: ["Temporal"], secondary: ["Frontal"], note: "Tender affect and regulation" },
            Veera: { primary: ["Frontal", "Parietal"], secondary: ["Central"], note: "Resolve and action planning" },
            Raudra: { primary: ["Frontal", "Temporal"], secondary: ["Parietal"], note: "Channel intensity into control" },
            Hasya: { primary: ["Temporal", "Frontal"], secondary: ["Parietal"], note: "Playful affect and social mirroring" },
            Bhayanaka: { primary: ["Frontal", "Parietal", "Temporal"], secondary: [], note: "Vigilance and threat evaluation" },
            Bibhatsa: { primary: ["Frontal", "Temporal"], secondary: ["Parietal"], note: "Aversive evaluation and disengagement" },
            Adbhuta: { primary: ["Parietal", "Occipital"], secondary: ["Frontal"], note: "Wonder via integration and imagery" },
            Shringara: { primary: ["Temporal", "Frontal"], secondary: ["Parietal"], note: "Attunement and tenderness" },
        };

        // ---------- build rasa encyclopedia ----------
        const rasaGrid = document.getElementById("rasaGrid");
        RASAS.forEach(r => {
            const el = document.createElement("div");
            el.className = "rasa-card";
            el.innerHTML = `<div style="font-weight:700">${r.key}</div><div class="subtle">${r.blurb}</div>`;
            el.onclick = () => { playRaga(r.key); };
            rasaGrid.appendChild(el);
        });

        // ---------- helpers ----------
        const fill = (el, v) => { el.style.width = Math.max(0, Math.min(1, v)) * 100 + "%"; };
        function setVA(val, aro) {
            // enforce range clamp to avoid accidental overflow
            const v = Math.max(-1, Math.min(1, val));
            const a = Math.max(-1, Math.min(1, aro));

            // map –1→1 → pixel coordinates
            // –1 → left/bottom edge, 0 → center, 1 → right/top edge
            const cx = 50 * (v + 1);          // converts to 0–100%
            const cy = 50 * (1 - a) + 0;      // flips vertically for visual intuition (high arousal up)

            const dot = document.getElementById("vaDot");
            dot.setAttribute("cx", cx);
            dot.setAttribute("cy", cy);

            // textual display (same values)
            // document.getElementById("valence").textContent = v.toFixed(2);
            // document.getElementById("arousal").textContent = a.toFixed(2);

            // stress example metric (β − α or similar proxy)
            // const stressVal = (a - v).toFixed(2);
            // document.getElementById("stress").textContent = stressVal;
        }
        function chipsHTML(list) { return (!list || !list.length) ? `<span class="subtle">—</span>` : list.map(x => `<span class="chip">${x}</span>`).join(""); }
        function renderTargets(targetObj) {
            const t = targetObj || { primary: [], secondary: [], note: "" };
            document.getElementById("t-primary").innerHTML = chipsHTML(t.primary);
            document.getElementById("t-secondary").innerHTML = chipsHTML(t.secondary);
            document.getElementById("t-explain").textContent = t.note || "";
        }
        function playRaga(rasa) {
            const info = RAGAS[rasa]; if (!info) return;
            document.getElementById("ragaNow").textContent = `${info.name} (${rasa})`;
            document.getElementById("ragaInfo").textContent = info.blurb + " Replace video IDs in code as needed.";
            const id = info.yt || "";
            document.getElementById("yt").src = id ? `https://www.youtube-nocookie.com/embed/${id}?autoplay=1&mute=1&rel=0&modestbranding=1` : "";
        }

        // draw gridlines for VA plot (10% spacing + thicker axes)
        (function drawGrid() {
            const g = document.getElementById("grid");
            for (let i = 10; i < 100; i += 10) {
                const opacity = (i === 50) ? 0.7 : 0.25;
                const w = (i === 50) ? 1.2 : 0.6;
                const h = (i === 50) ? 1.2 : 0.6;
                const v = document.createElementNS("http://www.w3.org/2000/svg", "line");
                v.setAttribute("x1", i); v.setAttribute("x2", i); v.setAttribute("y1", 0); v.setAttribute("y2", 100);
                v.setAttribute("stroke", "#cfd5e6"); v.setAttribute("stroke-opacity", opacity); v.setAttribute("stroke-width", w);
                const hline = document.createElementNS("http://www.w3.org/2000/svg", "line");
                hline.setAttribute("x1", 0); hline.setAttribute("x2", 100); hline.setAttribute("y1", i); hline.setAttribute("y2", i);
                hline.setAttribute("stroke", "#cfd5e6"); hline.setAttribute("stroke-opacity", opacity); hline.setAttribute("stroke-width", h);
                g.appendChild(v); g.appendChild(hline);
            }
        })();

        // dataset modal
        const modal = document.getElementById("modal");
        document.getElementById("peek").onclick = async () => {
            modal.classList.add("open");
            const res = await fetch("/dataset_preview").catch(() => null);
            if (!res || !res.ok) {
                document.getElementById("tableWrap").innerHTML = "<p class='subtle'>Backend not available. Add /dataset_preview to show a real sample.</p>";
                return;
            }
            const data = await res.json();
            const thead = `<thead><tr>${data.columns.map(c => `<th>${c}</th>`).join("")}</tr></thead>`;
            const tbody = `<tbody>${data.rows.map(r => `<tr>${r.map(v => `<td>${v}</td>`).join("")}</tr>`).join("")}</tbody>`;
            document.getElementById("tableWrap").innerHTML = `<table>${thead}${tbody}</table>`;
        };
        document.getElementById("close").onclick = () => modal.classList.remove("open");

        // backend call
        async function callPredict(profile) {
            try {
                const res = await fetch("/predict", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ profile })
                });
                if (!res.ok) throw new Error("bad status");
                return await res.json(); // may include: targets:{primary:[],secondary:[],note:""}
            } catch { return null; }
        }

        // main predict flow
        document.getElementById("predict").addEventListener("click", async () => {
            const key = document.getElementById("profile").value;
            if (!key) { alert("Select a profile first"); return; }

            const api = await callPredict(key);
            const center = PROFILE[key] || { alpha: .6, beta: .5, theta: .5 };

            const rasa = api?.rasa ?? "Shanta";
            const raga = api?.raga ?? (RAGAS[rasa]?.name || "Revati");

            // Move output to right pane, update only #rasa and #raga
            document.getElementById("rasa").textContent = rasa;
            document.getElementById("raga").textContent = raga;
            playRaga(rasa);

            const val = api?.valence ?? Math.max(0, Math.min(1, (center.alpha - center.beta + 1) / 2));
            const aro = api?.arousal ?? Math.max(0, Math.min(1, (center.beta - center.theta + 1) / 2));
            const stress = api?.stress_global ?? Math.max(0, Math.min(1, (center.beta - center.alpha + 1) / 2));
            fill(document.getElementById("valence"), val);
            fill(document.getElementById("arousal"), aro);
            fill(document.getElementById("stress"), stress);
            setVA(val, aro);

            const w = api?.weights || { alpha: center.alpha / (center.alpha + center.beta + center.theta), beta: center.beta / (center.alpha + center.beta + center.theta), theta: center.theta / (center.alpha + center.beta + center.theta) };
            document.getElementById("w-alpha").textContent = (w.alpha ?? w.wAlpha).toFixed(2);
            document.getElementById("w-beta").textContent = (w.beta ?? w.wBeta).toFixed(2);
            document.getElementById("w-theta").textContent = (w.theta ?? w.wTheta).toFixed(2);
            document.getElementById("b-alpha").style.width = ((w.alpha ?? w.wAlpha) * 100) + "%";
            document.getElementById("b-beta").style.width = ((w.beta ?? w.wBeta) * 100) + "%";
            document.getElementById("b-theta").style.width = ((w.theta ?? w.wTheta) * 100) + "%";

            // targeted regions
            const targets = api?.targets || RASA_TARGETS[rasa] || PROFILE_TARGETS[key];
            renderTargets(targets);
        });

        // show profile-based targets when dropdown changes
        // document.getElementById("profile").addEventListener("change", (e) => {
        //     const key = e.target.value;
        //     if (!key) { renderTargets(null); return; }
        //     renderTargets(PROFILE_TARGETS[key]);
        // });
    </script>
</body>

</html>